rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // Checks if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // --- User Data Rules ---
    // User can read and write their own document and all sub-collections.
    match /users/{userId}/{path=**} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // --- Public Profile & Leaderboard Rules ---
    // Any signed-in user can read the top-level user document for profile information.
    match /users/{userId} {
      allow read: if isSignedIn();
    }
    // Any signed-in user can read boss contributions for the leaderboard.
    match /{path=**}/boss_contributions/{weekId} {
      allow read: if isSignedIn();
    }
    // Any signed-in user can read achievements for public profiles.
    match /users/{userId}/achievements/{achievementId} {
       allow read: if isSignedIn();
    }


    // --- Public & Shared Collections ---
    // Any signed-in user can read these collections.
    match /weekly_bosses/{bossId} {
      allow read: if isSignedIn();
    }
    match /app_config/{docId} {
      allow read: if isSignedIn();
    }
    match /quest_packs/{packId} {
      allow read: if isSignedIn();
    }

    // --- Admin-Specific Rules ---
    // Any signed-in user can submit feedback.
    match /feedback/{feedbackId} {
      allow create: if isSignedIn();
      // Only admins can read/update/delete feedback.
      allow read, update, delete: if exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    // Only admins can read/write announcements.
    match /announcements/{announcementId} {
      allow read, write: if exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }
  }
}
